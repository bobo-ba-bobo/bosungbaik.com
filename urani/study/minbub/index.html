<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìœ ë¼ë‹ˆì˜ ë¯¼ë²• ê³µë¶€ - ì•”ê¸° íŠ¸ë ˆì´ë„ˆ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1419;--s1:#1a2332;--s2:#233041;--bd:#2d3e50;
  --t1:#e8f4f8;--t2:#90b4c8;--t3:#607888;
  --p:#4a9eff;--pl:#74b9ff;--g:#00b894;--o:#fdcb6e;--r:#e17055;--b:#6dd5ed;
}
body{font-family:'Apple SD Gothic Neo',-apple-system,sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}

/* NAV */
nav{background:var(--s1);border-bottom:1px solid var(--bd);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
nav h1{font-size:17px;font-weight:700}
nav h1 span{color:var(--pl)}
.nav-stats{display:flex;gap:14px;font-size:12px;color:var(--t2)}
.nav-stats b{color:var(--t1)}

.container{max-width:900px;margin:0 auto;padding:20px}

/* TABS */
.tabs{display:flex;gap:4px;background:var(--s1);padding:4px;border-radius:14px;margin-bottom:20px;border:1px solid var(--bd)}
.tab{flex:1;padding:12px;text-align:center;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;color:var(--t2);transition:all .2s;user-select:none}
.tab.active{background:var(--p);color:#fff}
.tab:hover:not(.active){color:var(--t1)}
.tab .tab-icon{font-size:18px;display:block;margin-bottom:2px}

/* FILTERS */
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.fbtn{padding:6px 14px;border:1px solid var(--bd);border-radius:20px;background:transparent;color:var(--t2);font-size:12px;cursor:pointer;transition:all .2s}
.fbtn:hover{border-color:var(--p);color:var(--pl)}
.fbtn.on{background:var(--p);border-color:var(--p);color:#fff}

/* CARD */
.card{background:var(--s1);border:1px solid var(--bd);border-radius:14px;overflow:hidden}
.card-head{padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bd)}
.badge{font-size:11px;padding:3px 10px;border-radius:10px;font-weight:600}
.b-ìš”ê±´íš¨ê³¼{background:rgba(108,92,231,.2);color:var(--pl)}
.b-ë¹„êµ{background:rgba(0,184,148,.2);color:var(--g)}
.b-í•µì‹¬ìˆ«ì{background:rgba(253,203,110,.2);color:var(--o)}
.b-íŒë¡€{background:rgba(116,185,255,.2);color:var(--b)}
.b-ì¡°ë¬¸{background:rgba(225,112,85,.2);color:var(--r)}
.card-num{font-size:12px;color:var(--t2)}

.card-body{padding:24px 20px}
.card-body .part{font-size:11px;color:var(--t2);margin-bottom:4px}
.card-body h2{font-size:20px;font-weight:700;line-height:1.4;margin-bottom:6px}
.exam-tag{font-size:11px;color:var(--r);background:rgba(225,112,85,.12);padding:2px 8px;border-radius:4px}

/* TRACE MODE - answer visible above textarea */
.trace-answer{background:var(--s2);border-radius:10px;padding:16px;margin:0 20px 12px;font-size:14px;line-height:1.9;white-space:pre-wrap;color:var(--pl);border-left:3px solid var(--p);max-height:300px;overflow-y:auto}

/* TEXTAREA */
.input-wrap{padding:0 20px 16px}
textarea{width:100%;min-height:160px;background:var(--s2);border:2px solid var(--bd);border-radius:10px;color:var(--t1);font-family:inherit;font-size:14px;line-height:1.8;padding:14px;resize:vertical;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--p)}
textarea::placeholder{color:var(--t3)}

/* MATCH HIGHLIGHT */
.match-result{padding:0 20px 16px;display:none}
.match-result.show{display:block}
.match-bar{height:8px;background:var(--bd);border-radius:4px;overflow:hidden;margin-bottom:8px}
.match-fill{height:100%;border-radius:4px;transition:width .4s}
.match-info{display:flex;justify-content:space-between;font-size:13px}
.match-pct{font-weight:700}

/* ANSWER REVEAL */
.reveal{background:var(--s2);border-radius:10px;padding:16px;margin:0 20px 16px;display:none;font-size:14px;line-height:1.9;white-space:pre-wrap;border-left:3px solid var(--g)}
.reveal.show{display:block}
.reveal-label{font-size:12px;font-weight:600;color:var(--g);margin-bottom:8px}

/* ACTIONS */
.actions{padding:14px 20px;display:flex;gap:8px;border-top:1px solid var(--bd);flex-wrap:wrap}
.btn{padding:10px 18px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-p{background:var(--p);color:#fff}
.btn-p:hover{background:#5b4bd5}
.btn-g{background:var(--g);color:#fff}
.btn-g:hover{opacity:.9}
.btn-o{background:var(--o);color:#333}
.btn-r{background:rgba(225,112,85,.2);color:var(--r)}
.btn-s{background:var(--s2);color:var(--t2)}
.btn-s:hover{background:var(--bd);color:var(--t1)}
.btn-ghost{background:transparent;color:var(--t2);border:1px solid var(--bd)}
.spacer{flex:1}

.hint{text-align:center;font-size:11px;color:var(--t3);margin-top:10px}
.hint kbd{background:var(--s2);padding:1px 5px;border-radius:3px;border:1px solid var(--bd);font-size:10px}

/* === TAB 3: STATUS === */
.status-header{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin-bottom:20px}
@media(max-width:640px){.status-header{grid-template-columns:1fr 1fr}}
.scard{background:var(--s1);border:1px solid var(--bd);border-radius:12px;padding:16px}
.scard h4{font-size:11px;color:var(--t2);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.scard .num{font-size:28px;font-weight:700}
.num-g{color:var(--g)}.num-o{color:var(--o)}.num-b{color:var(--b)}.num-r{color:var(--r)}

.search-box{width:100%;padding:10px 14px;background:var(--s1);border:1px solid var(--bd);border-radius:8px;color:var(--t1);font-size:13px;outline:none;margin-bottom:12px}
.search-box:focus{border-color:var(--p)}

.status-list{display:flex;flex-direction:column;gap:6px}
.srow{background:var(--s1);border:1px solid var(--bd);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:border-color .15s}
.srow:hover{border-color:var(--p)}
.srow .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.dot-mastered{background:var(--g)}.dot-learning{background:var(--o)}.dot-new{background:var(--bd)}
.srow .info{flex:1;min-width:0}
.srow .title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.srow .meta{font-size:11px;color:var(--t2);margin-top:2px}
.srow .score-badge{font-size:12px;font-weight:700;padding:4px 10px;border-radius:6px;flex-shrink:0;display:flex;align-items:center;gap:6px}
.sb-high{background:rgba(0,184,148,.15);color:var(--g)}
.sb-mid{background:rgba(253,203,110,.15);color:var(--o)}
.sb-low{background:rgba(225,112,85,.15);color:var(--r)}
.sb-none{background:var(--s2);color:var(--t3)}
.score-edit-btn{background:var(--p);color:#fff;border:none;border-radius:4px;width:20px;height:20px;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0.7;transition:opacity .2s}
.score-edit-btn:hover{opacity:1}
.score-quick-edit{display:flex;gap:4px;margin-left:4px}
.score-quick-edit button{background:var(--s2);border:1px solid var(--bd);color:var(--t1);border-radius:4px;padding:2px 8px;font-size:11px;cursor:pointer}
.score-quick-edit button:hover{background:var(--bd)}

/* STATUS EDIT MODAL */
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.65);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-bg.show{display:flex}
.modal{background:var(--s1);border-radius:14px;max-width:560px;width:100%;max-height:85vh;overflow-y:auto;padding:28px}
.modal h2{font-size:17px;margin-bottom:6px}
.modal .part{font-size:11px;color:var(--t2);margin-bottom:16px}
.modal pre{font-family:inherit;white-space:pre-wrap;line-height:1.8;font-size:13px;background:var(--s2);padding:14px;border-radius:8px;margin-bottom:16px;max-height:250px;overflow-y:auto}
.modal label{font-size:13px;color:var(--t2);display:block;margin-bottom:6px}
.modal select{width:100%;padding:10px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;color:var(--t1);font-size:14px;margin-bottom:16px;outline:none}
.modal .score-edit{display:flex;gap:8px;align-items:center;margin-bottom:16px}
.modal input[type=range]{flex:1;accent-color:var(--p)}
.modal .score-val{font-size:18px;font-weight:700;min-width:48px;text-align:center}

.load-more{text-align:center;padding:16px}
</style>
</head>
<body>

<nav>
  <h1>ğŸ’™ <span>ìœ ë¼ë‹ˆì˜ ë¯¼ë²• ê³µë¶€</span></h1>
  <div class="nav-stats">
    <span id="sync-status" style="display:none;margin-right:8px;color:var(--g);font-size:11px">â˜ï¸ ë™ê¸°í™”</span>
    <button id="login-btn" class="btn btn-s" onclick="showLoginModal()" style="padding:5px 10px;font-size:11px;margin-right:8px">ë¡œê·¸ì¸</button>
    <span id="user-info" style="display:none;margin-right:8px;font-size:11px;color:var(--g)">ğŸ”’ ë¡œê·¸ì¸ë¨</span>
    <button id="logout-btn" class="btn btn-ghost" onclick="handleLogout()" style="display:none;padding:5px 10px;font-size:11px;margin-right:8px">ë¡œê·¸ì•„ì›ƒ</button>
    <span>ì™„ë£Œ <b id="n-done">0</b></span>
    <span>í•™ìŠµ <b id="n-learn">0</b></span>
    <span>ì „ì²´ <b id="n-total">0</b></span>
  </div>
</nav>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="trace" onclick="switchTab('trace')">
      <span class="tab-icon">&#9998;</span>ë”°ë¼ì“°ê¸°
    </div>
    <div class="tab" data-tab="test" onclick="switchTab('test')">
      <span class="tab-icon">&#128170;</span>ì•”ê¸°í…ŒìŠ¤íŠ¸
    </div>
    <div class="tab" data-tab="status" onclick="switchTab('status')">
      <span class="tab-icon">&#128202;</span>ì•”ê¸°í˜„í™©
    </div>
  </div>

  <!-- Shared filters (for tab 1 & 2) -->
  <div id="shared-filters">
    <div class="filters">
      <button class="fbtn on" data-f="all" onclick="setF('all',this)">ì „ì²´</button>
      <button class="fbtn" data-f="ìš”ê±´íš¨ê³¼" onclick="setF('ìš”ê±´íš¨ê³¼',this)">ìš”ê±´/íš¨ê³¼</button>
      <button class="fbtn" data-f="ë¹„êµ" onclick="setF('ë¹„êµ',this)">ë¹„êµ</button>
      <button class="fbtn" data-f="í•µì‹¬ìˆ«ì" onclick="setF('í•µì‹¬ìˆ«ì',this)">í•µì‹¬ìˆ«ì</button>
      <button class="fbtn" data-f="íŒë¡€" onclick="setF('íŒë¡€',this)">íŒë¡€</button>
      <button class="fbtn" data-f="ì¡°ë¬¸" onclick="setF('ì¡°ë¬¸',this)">ì¡°ë¬¸</button>
    </div>
    <div class="filters">
      <button class="fbtn on" data-p="all" onclick="setP('all',this)">ì „í¸</button>
      <button class="fbtn" data-p="ì œ1í¸ ë¯¼ë²•ì´ì¹™" onclick="setP('ì œ1í¸ ë¯¼ë²•ì´ì¹™',this)">ì´ì¹™</button>
      <button class="fbtn" data-p="ì œ2í¸ ì±„ê¶Œì´ë¡ " onclick="setP('ì œ2í¸ ì±„ê¶Œì´ë¡ ',this)">ì±„ê¶Œì´ë¡ </button>
      <button class="fbtn" data-p="ì œ3í¸ ì±„ê¶Œê°ë¡ " onclick="setP('ì œ3í¸ ì±„ê¶Œê°ë¡ ',this)">ì±„ê¶Œê°ë¡ </button>
      <button class="fbtn" data-p="ì œ4í¸ ë¬¼ê¶Œë²•" onclick="setP('ì œ4í¸ ë¬¼ê¶Œë²•',this)">ë¬¼ê¶Œë²•</button>
      <button class="fbtn" data-p="ì œ5í¸ ì¹œì¡±ìƒì†ë²•" onclick="setP('ì œ5í¸ ì¹œì¡±ìƒì†ë²•',this)">ì¹œì¡±ìƒì†</button>
    </div>
  </div>

  <!-- ========== TAB 1: ë”°ë¼ì“°ê¸° ========== -->
  <div id="tab-trace">
    <div class="card">
      <div class="card-head">
        <span class="badge" id="t1-badge">ìš”ê±´íš¨ê³¼</span>
        <span class="card-num" id="t1-num">1/1033</span>
      </div>
      <div class="card-body">
        <div class="part" id="t1-part"></div>
        <h2 id="t1-title">ë¡œë”© ì¤‘...</h2>
        <span class="exam-tag" id="t1-exam" style="display:none"></span>
      </div>
      <div class="trace-answer" id="t1-answer">ì •ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì•„ë˜ì— ê·¸ëŒ€ë¡œ ë”°ë¼ ì“°ì„¸ìš”.</div>
      <div class="input-wrap">
        <textarea id="t1-input" placeholder="ìœ„ì˜ ë‚´ìš©ì„ ë³´ë©´ì„œ ê·¸ëŒ€ë¡œ ë”°ë¼ ì“°ì„¸ìš”..."></textarea>
      </div>
      <div class="match-result" id="t1-match">
        <div class="match-bar"><div class="match-fill" id="t1-fill"></div></div>
        <div class="match-info"><span id="t1-match-msg"></span><span class="match-pct" id="t1-pct"></span></div>
      </div>
      <div class="actions">
        <button class="btn btn-p" onclick="traceCheck()">ì¼ì¹˜ë„ í™•ì¸</button>
        <button class="btn btn-g" onclick="traceDone()">ë‹¤ ì¼ë‹¤ â†’ ë‹¤ìŒ</button>
        <span class="spacer"></span>
        <button class="btn btn-ghost" onclick="prevCard()">â† ì´ì „</button>
        <button class="btn btn-ghost" onclick="nextCard()">ë‹¤ìŒ â†’</button>
      </div>
    </div>
    <div class="hint">ì •ë‹µì„ ë³´ë©´ì„œ ë”°ë¼ ì“°ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. ìµìˆ™í•´ì§€ë©´ <b>ì•”ê¸°í…ŒìŠ¤íŠ¸</b> íƒ­ìœ¼ë¡œ!</div>
  </div>

  <!-- ========== TAB 2: ì•”ê¸°í…ŒìŠ¤íŠ¸ ========== -->
  <div id="tab-test" style="display:none">
    <div class="card">
      <div class="card-head">
        <span class="badge" id="t2-badge">ìš”ê±´íš¨ê³¼</span>
        <span class="card-num" id="t2-num">1/1033</span>
      </div>
      <div class="card-body">
        <div class="part" id="t2-part"></div>
        <h2 id="t2-title">ë¡œë”© ì¤‘...</h2>
        <span class="exam-tag" id="t2-exam" style="display:none"></span>
      </div>
      <div class="input-wrap">
        <textarea id="t2-input" placeholder="ì •ë‹µì„ ì•ˆ ë³´ê³  ì¨ë³´ì„¸ìš”..."></textarea>
      </div>
      <div class="match-result" id="t2-match">
        <div class="match-bar"><div class="match-fill" id="t2-fill"></div></div>
        <div class="match-info"><span id="t2-match-msg"></span><span class="match-pct" id="t2-pct"></span></div>
      </div>
      <div class="reveal" id="t2-reveal">
        <div class="reveal-label">ì •ë‹µ</div>
        <span id="t2-answer"></span>
      </div>
      <div class="actions">
        <button class="btn btn-p" id="t2-btn-check" onclick="testCheck()">ì •ë‹µ í™•ì¸</button>
        <button class="btn btn-g" id="t2-btn-ok" style="display:none" onclick="testMark('mastered')">ì™¸ì› ë‹¤</button>
        <button class="btn btn-o" id="t2-btn-half" style="display:none" onclick="testMark('learning')">ì¢€ ë”</button>
        <button class="btn btn-r" id="t2-btn-fail" style="display:none" onclick="testMark('new')">ëª¨ë¥´ê² ë‹¤</button>
        <span class="spacer"></span>
        <button class="btn btn-ghost" onclick="prevCard()">â†</button>
        <button class="btn btn-ghost" onclick="nextCard()">â†’</button>
      </div>
    </div>
    <div class="hint"><kbd>Ctrl+Enter</kbd> ì •ë‹µí™•ì¸ Â· <kbd>1</kbd> ì™¸ì› ë‹¤ Â· <kbd>2</kbd> ì¢€ ë” Â· <kbd>3</kbd> ëª¨ë¥´ê² ë‹¤</div>
  </div>

  <!-- ========== TAB 3: ì•”ê¸°í˜„í™© ========== -->
  <div id="tab-status" style="display:none">
    <div class="status-header">
      <div class="scard"><h4>ì „ì²´ ì§„ë„</h4><div class="num num-g" id="s-pct">0%</div></div>
      <div class="scard"><h4>ì™„ë£Œ</h4><div class="num num-g" id="s-done">0</div></div>
      <div class="scard"><h4>í•™ìŠµì¤‘</h4><div class="num num-o" id="s-learn">0</div></div>
      <div class="scard"><h4>ë¯¸í•™ìŠµ</h4><div class="num num-r" id="s-new">0</div></div>
    </div>
    <div class="filters" id="status-filters">
      <button class="fbtn on" onclick="setSF('all',this)">ì „ì²´</button>
      <button class="fbtn" onclick="setSF('mastered',this)">ì™„ë£Œ</button>
      <button class="fbtn" onclick="setSF('learning',this)">í•™ìŠµì¤‘</button>
      <button class="fbtn" onclick="setSF('new',this)">ë¯¸í•™ìŠµ</button>
    </div>
    <input class="search-box" id="s-search" placeholder="ê²€ìƒ‰ (ì œëª©, ë‚´ìš©)..." oninput="renderStatus()">
    <div class="status-list" id="s-list"></div>
    <div class="load-more" id="s-more"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="part" id="m-part"></div>
    <h2 id="m-title"></h2>
    <pre id="m-answer"></pre>
    <label>ì•”ê¸° ìƒíƒœ</label>
    <select id="m-status" onchange="modalStatusChange()">
      <option value="new">ë¯¸í•™ìŠµ</option>
      <option value="learning">í•™ìŠµì¤‘</option>
      <option value="mastered">ì™„ë£Œ</option>
    </select>
    <label>ì ìˆ˜ (ì§ì ‘ ì¡°ì •)</label>
    <div class="score-edit">
      <input type="range" id="m-score" min="0" max="100" value="0" oninput="document.getElementById('m-score-val').textContent=this.value+'%'">
      <div class="score-val" id="m-score-val">0%</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-p" style="flex:1" onclick="saveModal()">ì €ì¥</button>
      <button class="btn btn-s" style="flex:1" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal-bg" id="login-modal" onclick="if(event.target===this)closeLoginModal()">
  <div class="modal" style="max-width:400px">
    <h2>â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™”</h2>
    <p style="font-size:13px;color:var(--t2);margin-bottom:20px">ì•”í˜¸ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ì§„ë„ë¥¼ ì´ì–´ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
    <label>ì•”í˜¸ (4ì ì´ìƒ)</label>
    <input type="password" id="login-password" placeholder="ì•”í˜¸ ì…ë ¥" style="width:100%;padding:10px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;color:var(--t1);font-size:14px;margin-bottom:16px;outline:none">
    <div id="login-error" style="display:none;color:var(--r);font-size:12px;margin-bottom:12px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-p" style="flex:1" onclick="handleLogin()">ë¡œê·¸ì¸</button>
      <button class="btn btn-s" style="flex:1" onclick="closeLoginModal()">ì·¨ì†Œ</button>
    </div>
    <p style="font-size:11px;color:var(--t3);margin-top:16px;text-align:center">ğŸ’¡ ê°™ì€ ì•”í˜¸ë¡œ ëª¨ë“  ê¸°ê¸°ì—ì„œ ì ‘ì†í•˜ì„¸ìš”</p>
  </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAaMrOed3Zhj4ceappFkMozjYBF-CYx4g8",
  authDomain: "urani-study.firebaseapp.com",
  projectId: "urani-study",
  storageBucket: "urani-study.firebasestorage.app",
  messagingSenderId: "595550201149",
  appId: "1:595550201149:web:328525a314582c70ac5154"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let currentUserId = null;

// Hash password to create user ID
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

let CARDS=[], state={}, curTab='trace', curF='all', curP='all', curSF='all';
let filtered=[], idx=0;
let statusPage=0;
const PAGE_SIZE=50;

function load(){try{const s=localStorage.getItem('mb2');if(s)state=JSON.parse(s)}catch(e){}}
async function save(){
  localStorage.setItem('mb2',JSON.stringify(state));
  if(currentUserId){
    try{
      await setDoc(doc(db,'users',currentUserId),{progress:state,lastUpdated:Date.now()},{merge:true});
      document.getElementById('sync-status').style.display='inline';
      setTimeout(()=>document.getElementById('sync-status').style.display='none',2000);
    }catch(e){console.error('Sync error:',e)}
  }
}
function gs(id){return state[id]||{s:'new',sc:0,n:0}}
function ss(id,u){if(!state[id])state[id]={s:'new',sc:0,n:0};Object.assign(state[id],u);save()}

function applyFilter(){
  filtered=CARDS.filter(c=>{
    if(curF!=='all'&&c.category!==curF)return false;
    if(curP!=='all'&&c.part!==curP)return false;
    return true;
  });
  filtered.sort((a,b)=>{
    if(a.priority!==b.priority)return a.priority-b.priority;
    const o={new:0,learning:1,mastered:2};
    return(o[gs(a.id).s]||0)-(o[gs(b.id).s]||0);
  });
  idx=0;
  render();
}

window.setF=function(f,el){curF=f;document.querySelectorAll('[data-f]').forEach(b=>b.classList.toggle('on',b.dataset.f===f));applyFilter()}
window.setP=function(p,el){curP=p;document.querySelectorAll('[data-p]').forEach(b=>b.classList.toggle('on',b.dataset.p===p));applyFilter()}
window.setSF=function(f,el){curSF=f;el.parentElement.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));el.classList.add('on');renderStatus()}

window.switchTab=function(t){
  curTab=t;
  document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x.dataset.tab===t));
  document.getElementById('tab-trace').style.display=t==='trace'?'':'none';
  document.getElementById('tab-test').style.display=t==='test'?'':'none';
  document.getElementById('tab-status').style.display=t==='status'?'':'none';
  document.getElementById('shared-filters').style.display=t==='status'?'none':'';
  render();
}

window.render=function(){
  updateNav();
  if(curTab==='trace')renderTrace();
  else if(curTab==='test')renderTest();
  else renderStatus();
}

function updateNav(){
  let done=0,learn=0;
  CARDS.forEach(c=>{const s=gs(c.id).s;if(s==='mastered')done++;else if(s==='learning')learn++});
  document.getElementById('n-done').textContent=done;
  document.getElementById('n-learn').textContent=learn;
  document.getElementById('n-total').textContent=CARDS.length;
}

// ===== TAB 1: TRACE =====
window.renderTrace=function(){
  if(!filtered.length)return;
  const c=filtered[idx];
  document.getElementById('t1-badge').className='badge b-'+c.category;
  document.getElementById('t1-badge').textContent=c.category;
  document.getElementById('t1-num').textContent=`${idx+1}/${filtered.length}`;
  const partText = c.page ? `${c.part} (p.${c.page})` : c.part;
  document.getElementById('t1-part').textContent=partText;
  document.getElementById('t1-title').textContent=c.prompt;
  document.getElementById('t1-answer').textContent=c.answer;
  document.getElementById('t1-input').value='';
  document.getElementById('t1-match').classList.remove('show');
  if(c.exam){document.getElementById('t1-exam').style.display='inline';document.getElementById('t1-exam').textContent='ê¸°ì¶œ: '+c.exam}
  else document.getElementById('t1-exam').style.display='none';
}

window.traceCheck=function(){
  const c=filtered[idx];
  const sc=score(document.getElementById('t1-input').value, c.answer);
  showMatch('t1',sc);
}

window.traceDone=function(){
  const c=filtered[idx];
  const sc=score(document.getElementById('t1-input').value, c.answer);
  const prev=gs(c.id);
  ss(c.id,{s:prev.s==='new'?'learning':prev.s, sc:Math.max(prev.sc,sc), n:prev.n+1});
  nextCard();
}

// ===== TAB 2: TEST =====
window.renderTest=function(){
  if(!filtered.length)return;
  const c=filtered[idx];
  document.getElementById('t2-badge').className='badge b-'+c.category;
  document.getElementById('t2-badge').textContent=c.category;
  document.getElementById('t2-num').textContent=`${idx+1}/${filtered.length}`;
  const partText2 = c.page ? `${c.part} (p.${c.page})` : c.part;
  document.getElementById('t2-part').textContent=partText2;
  document.getElementById('t2-title').textContent=c.prompt;
  document.getElementById('t2-input').value='';
  document.getElementById('t2-match').classList.remove('show');
  document.getElementById('t2-reveal').classList.remove('show');
  document.getElementById('t2-btn-check').style.display='';
  document.getElementById('t2-btn-ok').style.display='none';
  document.getElementById('t2-btn-half').style.display='none';
  document.getElementById('t2-btn-fail').style.display='none';
  if(c.exam){document.getElementById('t2-exam').style.display='inline';document.getElementById('t2-exam').textContent='ê¸°ì¶œ: '+c.exam}
  else document.getElementById('t2-exam').style.display='none';
}

window.testCheck=function(){
  const c=filtered[idx];
  const sc=score(document.getElementById('t2-input').value, c.answer);
  showMatch('t2',sc);
  document.getElementById('t2-answer').textContent=c.answer;
  document.getElementById('t2-reveal').classList.add('show');
  document.getElementById('t2-btn-check').style.display='none';
  document.getElementById('t2-btn-ok').style.display='';
  document.getElementById('t2-btn-half').style.display='';
  document.getElementById('t2-btn-fail').style.display='';
  ss(c.id,{sc, n:(gs(c.id).n||0)+1});
}

window.testMark=function(status){
  const c=filtered[idx];
  ss(c.id,{s:status});
  updateNav();
  nextCard();
}

// ===== TAB 3: STATUS =====
window.renderStatus=function(){
  let done=0,learn=0,nw=0;
  CARDS.forEach(c=>{const s=gs(c.id).s;if(s==='mastered')done++;else if(s==='learning')learn++;else nw++});
  const pct=CARDS.length?Math.round(done/CARDS.length*100):0;
  document.getElementById('s-pct').textContent=pct+'%';
  document.getElementById('s-done').textContent=done;
  document.getElementById('s-learn').textContent=learn;
  document.getElementById('s-new').textContent=nw;

  const q=(document.getElementById('s-search').value||'').toLowerCase();
  let items=CARDS.filter(c=>{
    const st=gs(c.id).s;
    if(curSF!=='all'&&st!==curSF)return false;
    if(curF!=='all'&&c.category!==curF)return false;
    if(curP!=='all'&&c.part!==curP)return false;
    if(q&&!c.prompt.toLowerCase().includes(q)&&!c.answer.toLowerCase().includes(q))return false;
    return true;
  });

  // Sort: mastered last
  items.sort((a,b)=>{
    const o={new:0,learning:1,mastered:2};
    return(o[gs(a.id).s]||0)-(o[gs(b.id).s]||0);
  });

  const list=document.getElementById('s-list');
  const show=items.slice(0, PAGE_SIZE);
  list.innerHTML=show.map(c=>{
    const st=gs(c.id);
    const dotCls=st.s==='mastered'?'dot-mastered':st.s==='learning'?'dot-learning':'dot-new';
    const sbCls=st.sc>=80?'sb-high':st.sc>=50?'sb-mid':st.sc>0?'sb-low':'sb-none';
    const scText=st.sc+'%';
    return`<div class="srow">
      <div class="dot ${dotCls}"></div>
      <div class="info" onclick="openModal('${c.id}')" style="cursor:pointer">
        <div class="title">${esc(c.prompt)}</div>
        <div class="meta">${c.part}${c.page?' (p.'+c.page+')':''} Â· ${c.category}${c.exam?' Â· ê¸°ì¶œ':''}${st.n>0?' Â· '+st.n+'íšŒ':''}</div>
      </div>
      <div class="score-badge ${sbCls}">
        ${scText}
        <button class="score-edit-btn" onclick="event.stopPropagation();toggleQuickEdit('${c.id}')" title="ì ìˆ˜ ì¡°ì •">âœï¸</button>
      </div>
      <div id="qe-${c.id}" class="score-quick-edit" style="display:none">
        <button onclick="quickScore('${c.id}',-10)">-10</button>
        <button onclick="quickScore('${c.id}',-5)">-5</button>
        <button onclick="quickScore('${c.id}',5)">+5</button>
        <button onclick="quickScore('${c.id}',10)">+10</button>
      </div>
    </div>`;
  }).join('');

  const moreEl=document.getElementById('s-more');
  if(items.length>PAGE_SIZE){
    moreEl.innerHTML=`<button class="btn btn-s" onclick="loadMore()">ë” ë³´ê¸° (${items.length-PAGE_SIZE}ê°œ ë‚¨ìŒ)</button>`;
  } else moreEl.innerHTML='';
}

let statusShowCount=PAGE_SIZE;
window.loadMore=function(){statusShowCount+=PAGE_SIZE;renderStatus()}

// ===== QUICK SCORE EDIT =====
window.toggleQuickEdit=function(id){
  const el=document.getElementById('qe-'+id);
  const isHidden=el.style.display==='none';
  // Hide all other quick edits
  document.querySelectorAll('.score-quick-edit').forEach(e=>e.style.display='none');
  // Toggle this one
  el.style.display=isHidden?'flex':'none';
}

window.quickScore=function(id,delta){
  const st=gs(id);
  const newScore=Math.max(0,Math.min(100,st.sc+delta));
  ss(id,{sc:newScore});
  renderStatus();
  render();
}

// ===== MODAL =====
let modalCardId=null;
window.openModal=function(id){
  modalCardId=id;
  const c=CARDS.find(x=>x.id===id);
  const st=gs(id);
  const modalPart = c.page ? `${c.part} (p.${c.page}) Â· ${c.category}` : `${c.part} Â· ${c.category}`;
  document.getElementById('m-part').textContent=modalPart;
  document.getElementById('m-title').textContent=c.prompt;
  document.getElementById('m-answer').textContent=c.answer;
  document.getElementById('m-status').value=st.s;
  document.getElementById('m-score').value=st.sc;
  document.getElementById('m-score-val').textContent=st.sc+'%';
  document.getElementById('modal').classList.add('show');
}
window.closeModal=function(){document.getElementById('modal').classList.remove('show');modalCardId=null}
function modalStatusChange(){}
window.saveModal=function(){
  if(!modalCardId)return;
  const newStatus=document.getElementById('m-status').value;
  const newScore=parseInt(document.getElementById('m-score').value);
  ss(modalCardId,{s:newStatus, sc:newScore});
  closeModal();
  render();
}

// ===== SCORING =====
function score(user,answer){
  const kw=t=>(t.match(/[ê°€-í£]{2,}/g)||[]);
  const ak=[...new Set(kw(answer))];
  if(!ak.length)return 100;
  const un=user.replace(/[\s.,;:!?()\[\]{}Â·â€¢â†’â†â‘ -â‘©/\\'"~`]/g,'').toLowerCase();
  let hit=0;
  ak.forEach(w=>{if(un.includes(w.toLowerCase()))hit++});
  return Math.round(hit/ak.length*100);
}

function showMatch(prefix,sc){
  const el=document.getElementById(prefix+'-match');
  el.classList.add('show');
  const fill=document.getElementById(prefix+'-fill');
  fill.style.width=sc+'%';
  fill.style.background=sc>=80?'var(--g)':sc>=50?'var(--o)':'var(--r)';
  document.getElementById(prefix+'-pct').textContent=sc+'%';
  document.getElementById(prefix+'-pct').style.color=sc>=80?'var(--g)':sc>=50?'var(--o)':'var(--r)';
  const msg=sc>=80?'ê±°ì˜ ì™„ë²½!':sc>=50?'ì ˆë°˜ ì´ìƒ ë§ì•˜ì–´ìš”':sc>0?'ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ë³´ì„¸ìš”':'ì •ë‹µì„ í™•ì¸í•˜ì„¸ìš”';
  document.getElementById(prefix+'-match-msg').textContent=msg;
}

function esc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ===== NAV =====
window.nextCard=function(){idx=(idx+1)%filtered.length;render()}
window.prevCard=function(){idx=(idx-1+filtered.length)%filtered.length;render()}

// ===== KEYBOARD =====
document.addEventListener('keydown',e=>{
  if(curTab==='status')return;
  if(e.target.tagName==='TEXTAREA'){
    if(e.key==='Enter'&&e.ctrlKey){e.preventDefault();curTab==='trace'?traceCheck():testCheck()}
    return;
  }
  if(e.key==='ArrowRight')nextCard();
  if(e.key==='ArrowLeft')prevCard();
  if(curTab==='test'){
    if(e.key==='1')testMark('mastered');
    if(e.key==='2')testMark('learning');
    if(e.key==='3')testMark('new');
  }
});

// ===== LOGIN/LOGOUT =====
window.showLoginModal=function(){
  document.getElementById('login-modal').classList.add('show');
  document.getElementById('login-password').value='';
  document.getElementById('login-error').style.display='none';
  setTimeout(()=>document.getElementById('login-password').focus(),100);
}

window.closeLoginModal=function(){
  document.getElementById('login-modal').classList.remove('show');
}

window.handleLogin=async function(){
  const password=document.getElementById('login-password').value;
  const errorEl=document.getElementById('login-error');

  if(!password||password.length<4){
    errorEl.textContent='ì•”í˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•´ìš”';
    errorEl.style.display='block';
    return;
  }

  try{
    currentUserId=await hashPassword(password);
    const docRef=doc(db,'users',currentUserId);
    const docSnap=await getDoc(docRef);

    if(docSnap.exists()){
      const cloudData=docSnap.data();
      state=cloudData.progress||{};
      localStorage.setItem('mb2',JSON.stringify(state));
      alert('â˜ï¸ í´ë¼ìš°ë“œì—ì„œ ì§„ë„ë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”!');
    }else{
      await setDoc(docRef,{progress:state,createdAt:Date.now(),lastUpdated:Date.now()});
      alert('âœ¨ ìƒˆë¡œìš´ ê³„ì •ì´ ë§Œë“¤ì–´ì¡Œì–´ìš”!\nì´ì œ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ê°™ì€ ì•”í˜¸ë¡œ ë¡œê·¸ì¸í•˜ë©´ ì§„ë„ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤.');
    }

    document.getElementById('login-btn').style.display='none';
    document.getElementById('user-info').style.display='inline';
    document.getElementById('logout-btn').style.display='inline';
    closeLoginModal();
    render();
  }catch(e){
    console.error('Login error:',e);
    errorEl.textContent='ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message;
    errorEl.style.display='block';
  }
}

window.handleLogout=function(){
  if(confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ì–´ìš”?\në¡œì»¬ ì§„ë„ëŠ” ìœ ì§€ë˜ì§€ë§Œ í´ë¼ìš°ë“œ ë™ê¸°í™”ëŠ” ì¤‘ì§€ë©ë‹ˆë‹¤.')){
    currentUserId=null;
    document.getElementById('login-btn').style.display='inline';
    document.getElementById('user-info').style.display='none';
    document.getElementById('logout-btn').style.display='none';
    document.getElementById('sync-status').style.display='none';
  }
}

// ===== INIT =====
async function init(){
  load();
  try{
    const r=await fetch('cards_data.json');
    const d=await r.json();
    CARDS=d.cards;
  }catch(e){
    document.getElementById('t1-title').textContent='cards_data.json ë¡œë“œ ì‹¤íŒ¨';
    return;
  }
  applyFilter();
}
init();
</script>
</body>
</html>
