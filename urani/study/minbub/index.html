<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Urani Minbub Ganbare <3</title>
<link rel="stylesheet" href="../../../style.css">
<style>
/* Minimal custom styles for flashcard app */
body {
  background: #fff;
}

nav {
  border-bottom: 1px solid #e0e0e0;
}

nav .container {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

nav h1 {
  font-size: 15px;
  font-weight: 500;
  margin-bottom: 0;
}

.nav-stats {
  display: flex;
  gap: 14px;
  font-size: 12px;
  color: #616161;
}

.nav-stats b {
  color: #000;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 40px;
  border-bottom: 1px solid #e0e0e0;
}

.tab {
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 400;
  cursor: pointer;
  color: #616161;
  transition: all 0.2s;
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
}

.tab:hover {
  color: #000;
}

.tab.active {
  color: #000;
  border-bottom-color: #000;
}

/* Filters */
.filters {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.fbtn {
  padding: 5px 12px;
  border: 1px solid #e0e0e0;
  background: transparent;
  color: #616161;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.fbtn:hover {
  border-color: #000;
  color: #000;
}

.fbtn.on {
  background: #000;
  border-color: #000;
  color: #fff;
}

/* Card */
.card {
  border: 1px solid #e0e0e0;
  margin-bottom: 50px;
}

.card-head {
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e0e0e0;
}

.badge {
  font-size: 11px;
  padding: 3px 8px;
  background: #f5f5f5;
  color: #616161;
  font-weight: 500;
}

.card-num {
  font-size: 12px;
  color: #616161;
}

.card-body {
  padding: 20px 16px;
}

.card-body .part {
  font-size: 11px;
  color: #616161;
  margin-bottom: 4px;
}

.card-body h2 {
  font-size: 17px;
  font-weight: 500;
  margin-bottom: 6px;
  text-transform: none;
  letter-spacing: -0.01em;
}

.exam-tag {
  font-size: 11px;
  color: #616161;
  background: #f5f5f5;
  padding: 2px 8px;
}

/* Trace answer box */
.trace-answer {
  background: #f5f5f5;
  padding: 14px 16px;
  margin: 0 16px 12px;
  font-size: 14px;
  line-height: 1.7;
  white-space: pre-wrap;
  color: #000;
  border-left: 2px solid #000;
  max-height: 300px;
  overflow-y: auto;
}

/* Textarea */
.input-wrap {
  padding: 0 16px 14px;
}

textarea {
  width: 100%;
  min-height: 140px;
  background: #fff;
  border: 1px solid #e0e0e0;
  color: #000;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.7;
  padding: 12px;
  resize: vertical;
  transition: border-color 0.2s;
}

textarea:focus {
  outline: none;
  border-color: #000;
}

textarea::placeholder {
  color: #999;
}

/* Match result */
.match-result {
  padding: 0 16px 14px;
  display: none;
}

.match-result.show {
  display: block;
}

.match-bar {
  height: 6px;
  background: #f5f5f5;
  overflow: hidden;
  margin-bottom: 6px;
}

.match-fill {
  height: 100%;
  background: #000;
  transition: width 0.4s;
}

.match-info {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #616161;
}

.match-pct {
  font-weight: 500;
  color: #000;
}

/* Answer reveal */
.reveal {
  background: #f5f5f5;
  padding: 14px 16px;
  margin: 0 16px 14px;
  display: none;
  font-size: 14px;
  line-height: 1.7;
  white-space: pre-wrap;
  border-left: 2px solid #000;
}

.reveal.show {
  display: block;
}

.reveal-label {
  font-size: 11px;
  font-weight: 500;
  color: #000;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Actions */
.actions {
  padding: 12px 16px;
  display: flex;
  gap: 6px;
  border-top: 1px solid #e0e0e0;
  flex-wrap: wrap;
}

.btn {
  padding: 8px 14px;
  border: 1px solid #000;
  background: #000;
  color: #fff;
  font-size: 12px;
  font-weight: 400;
  cursor: pointer;
  transition: all 0.2s;
}

.btn:hover {
  background: #fff;
  color: #000;
}

.btn-ghost {
  background: transparent;
  color: #000;
  border-color: #e0e0e0;
}

.btn-ghost:hover {
  background: #000;
  color: #fff;
}

.spacer {
  flex: 1;
}

.hint {
  text-align: center;
  font-size: 11px;
  color: #999;
  margin-top: 10px;
}

.hint kbd {
  background: #f5f5f5;
  padding: 2px 6px;
  border: 1px solid #e0e0e0;
  font-size: 10px;
}

/* Status tab */
.status-header {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 10px;
  margin-bottom: 30px;
}

@media(max-width: 640px) {
  .status-header {
    grid-template-columns: 1fr 1fr;
  }
}

.scard {
  border: 1px solid #e0e0e0;
  padding: 14px;
}

.scard h4 {
  font-size: 10px;
  color: #616161;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 6px;
  font-weight: 500;
}

.scard .num {
  font-size: 24px;
  font-weight: 500;
  color: #000;
}

.search-box {
  width: 100%;
  padding: 10px 12px;
  background: #fff;
  border: 1px solid #e0e0e0;
  color: #000;
  font-size: 13px;
  outline: none;
  margin-bottom: 10px;
}

.search-box:focus {
  border-color: #000;
}

.status-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.srow {
  border: 1px solid #e0e0e0;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.srow:hover {
  border-color: #000;
}

.srow .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  background: #e0e0e0;
}

.dot-mastered {
  background: #000;
}

.dot-learning {
  background: #616161;
}

.srow .info {
  flex: 1;
  min-width: 0;
}

.srow .title {
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.srow .meta {
  font-size: 11px;
  color: #616161;
  margin-top: 2px;
}

.srow .score-badge {
  font-size: 11px;
  font-weight: 500;
  padding: 4px 8px;
  background: #f5f5f5;
  color: #616161;
  flex-shrink: 0;
}

.sb-high {
  background: #000;
  color: #fff;
}

.sb-mid {
  background: #616161;
  color: #fff;
}

.load-more {
  text-align: center;
  padding: 16px;
}

/* Modal */
.modal-bg {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-bg.show {
  display: flex;
}

.modal {
  background: #fff;
  max-width: 520px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 24px;
  border: 1px solid #000;
}

.modal h2 {
  font-size: 16px;
  margin-bottom: 6px;
  text-transform: none;
  letter-spacing: -0.01em;
}

.modal .part {
  font-size: 11px;
  color: #616161;
  margin-bottom: 14px;
}

.modal pre {
  font-family: inherit;
  white-space: pre-wrap;
  line-height: 1.7;
  font-size: 13px;
  background: #f5f5f5;
  padding: 12px;
  margin-bottom: 14px;
  max-height: 220px;
  overflow-y: auto;
}

.modal label {
  font-size: 12px;
  color: #616161;
  display: block;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.modal select {
  width: 100%;
  padding: 10px;
  background: #fff;
  border: 1px solid #e0e0e0;
  color: #000;
  font-size: 13px;
  margin-bottom: 14px;
  outline: none;
}

.modal .score-edit {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 14px;
}

.modal input[type=range] {
  flex: 1;
}

.modal .score-val {
  font-size: 16px;
  font-weight: 500;
  min-width: 48px;
  text-align: center;
}
</style>
</head>
<body>

<nav>
  <div class="container">
    <h1>Urani Minbub Ganbare <3</h1>
    <div class="nav-stats">
      <span id="sync-status" style="display:none;margin-right:8px;color:#000;font-size:11px">â˜ï¸ ë™ê¸°í™”</span>
      <button id="login-btn" class="btn btn-s" onclick="showLoginModal()" style="padding:5px 10px;font-size:11px;margin-right:8px">ë¡œê·¸ì¸</button>
      <span id="user-info" style="display:none;margin-right:8px;font-size:11px">ğŸ”’ ë¡œê·¸ì¸ë¨</span>
      <button id="logout-btn" class="btn btn-ghost" onclick="handleLogout()" style="display:none;padding:5px 10px;font-size:11px;margin-right:8px">ë¡œê·¸ì•„ì›ƒ</button>
      <span>ì™„ë£Œ <b id="n-done">0</b></span>
      <span>í•™ìŠµ <b id="n-learn">0</b></span>
      <span>ì „ì²´ <b id="n-total">0</b></span>
    </div>
  </div>
</nav>

<main>
  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="trace" onclick="switchTab('trace')">ë”°ë¼ì“°ê¸°</div>
      <div class="tab" data-tab="test" onclick="switchTab('test')">ì•”ê¸°í…ŒìŠ¤íŠ¸</div>
      <div class="tab" data-tab="status" onclick="switchTab('status')">ì•”ê¸°í˜„í™©</div>
    </div>

    <!-- Shared filters (for tab 1 & 2) -->
    <div id="shared-filters">
      <div class="filters">
        <button class="fbtn on" data-f="all" onclick="setF('all',this)">ì „ì²´</button>
        <button class="fbtn" data-f="ìš”ê±´íš¨ê³¼" onclick="setF('ìš”ê±´íš¨ê³¼',this)">ìš”ê±´/íš¨ê³¼</button>
        <button class="fbtn" data-f="ë¹„êµ" onclick="setF('ë¹„êµ',this)">ë¹„êµ</button>
        <button class="fbtn" data-f="í•µì‹¬ìˆ«ì" onclick="setF('í•µì‹¬ìˆ«ì',this)">í•µì‹¬ìˆ«ì</button>
        <button class="fbtn" data-f="íŒë¡€" onclick="setF('íŒë¡€',this)">íŒë¡€</button>
        <button class="fbtn" data-f="ì¡°ë¬¸" onclick="setF('ì¡°ë¬¸',this)">ì¡°ë¬¸</button>
      </div>
      <div class="filters">
        <button class="fbtn on" data-p="all" onclick="setP('all',this)">ì „í¸</button>
        <button class="fbtn" data-p="ì œ1í¸ ë¯¼ë²•ì´ì¹™" onclick="setP('ì œ1í¸ ë¯¼ë²•ì´ì¹™',this)">ì´ì¹™</button>
        <button class="fbtn" data-p="ì œ2í¸ ì±„ê¶Œì´ë¡ " onclick="setP('ì œ2í¸ ì±„ê¶Œì´ë¡ ',this)">ì±„ê¶Œì´ë¡ </button>
        <button class="fbtn" data-p="ì œ3í¸ ì±„ê¶Œê°ë¡ " onclick="setP('ì œ3í¸ ì±„ê¶Œê°ë¡ ',this)">ì±„ê¶Œê°ë¡ </button>
        <button class="fbtn" data-p="ì œ4í¸ ë¬¼ê¶Œë²•" onclick="setP('ì œ4í¸ ë¬¼ê¶Œë²•',this)">ë¬¼ê¶Œë²•</button>
        <button class="fbtn" data-p="ì œ5í¸ ì¹œì¡±ìƒì†ë²•" onclick="setP('ì œ5í¸ ì¹œì¡±ìƒì†ë²•',this)">ì¹œì¡±ìƒì†</button>
      </div>
    </div>

    <!-- ========== TAB 1: ë”°ë¼ì“°ê¸° ========== -->
    <div id="tab-trace">
      <div class="card">
        <div class="card-head">
          <span class="badge" id="t1-badge">ìš”ê±´íš¨ê³¼</span>
          <span class="card-num" id="t1-num">1/1033</span>
        </div>
        <div class="card-body">
          <div class="part" id="t1-part"></div>
          <h2 id="t1-title">ë¡œë”© ì¤‘...</h2>
          <span class="exam-tag" id="t1-exam" style="display:none"></span>
        </div>
        <div class="trace-answer" id="t1-answer">ì •ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. ì•„ë˜ì— ê·¸ëŒ€ë¡œ ë”°ë¼ ì“°ì„¸ìš”.</div>
        <div class="input-wrap">
          <textarea id="t1-input" placeholder="ìœ„ì˜ ë‚´ìš©ì„ ë³´ë©´ì„œ ê·¸ëŒ€ë¡œ ë”°ë¼ ì“°ì„¸ìš”..."></textarea>
        </div>
        <div class="match-result" id="t1-match">
          <div class="match-bar"><div class="match-fill" id="t1-fill"></div></div>
          <div class="match-info"><span id="t1-match-msg"></span><span class="match-pct" id="t1-pct"></span></div>
        </div>
        <div class="actions">
          <button class="btn" onclick="traceCheck()">ì¼ì¹˜ë„ í™•ì¸</button>
          <button class="btn" onclick="traceDone()">ë‹¤ ì¼ë‹¤ â†’ ë‹¤ìŒ</button>
          <span class="spacer"></span>
          <button class="btn btn-ghost" onclick="prevCard()">â† ì´ì „</button>
          <button class="btn btn-ghost" onclick="nextCard()">ë‹¤ìŒ â†’</button>
        </div>
      </div>
      <div class="hint">ì •ë‹µì„ ë³´ë©´ì„œ ë”°ë¼ ì“°ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. ìµìˆ™í•´ì§€ë©´ <b>ì•”ê¸°í…ŒìŠ¤íŠ¸</b> íƒ­ìœ¼ë¡œ!</div>
    </div>

    <!-- ========== TAB 2: ì•”ê¸°í…ŒìŠ¤íŠ¸ ========== -->
    <div id="tab-test" style="display:none">
      <div class="card">
        <div class="card-head">
          <span class="badge" id="t2-badge">ìš”ê±´íš¨ê³¼</span>
          <span class="card-num" id="t2-num">1/1033</span>
        </div>
        <div class="card-body">
          <div class="part" id="t2-part"></div>
          <h2 id="t2-title">ë¡œë”© ì¤‘...</h2>
          <span class="exam-tag" id="t2-exam" style="display:none"></span>
        </div>
        <div class="input-wrap">
          <textarea id="t2-input" placeholder="ì •ë‹µì„ ì•ˆ ë³´ê³  ì¨ë³´ì„¸ìš”..."></textarea>
        </div>
        <div class="match-result" id="t2-match">
          <div class="match-bar"><div class="match-fill" id="t2-fill"></div></div>
          <div class="match-info"><span id="t2-match-msg"></span><span class="match-pct" id="t2-pct"></span></div>
        </div>
        <div class="reveal" id="t2-reveal">
          <div class="reveal-label">ì •ë‹µ</div>
          <span id="t2-answer"></span>
        </div>
        <div class="actions">
          <button class="btn" id="t2-btn-check" onclick="testCheck()">ì •ë‹µ í™•ì¸</button>
          <button class="btn" id="t2-btn-ok" style="display:none" onclick="testMark('mastered')">ì™¸ì› ë‹¤</button>
          <button class="btn" id="t2-btn-half" style="display:none" onclick="testMark('learning')">ì¢€ ë”</button>
          <button class="btn btn-ghost" id="t2-btn-fail" style="display:none" onclick="testMark('new')">ëª¨ë¥´ê² ë‹¤</button>
          <span class="spacer"></span>
          <button class="btn btn-ghost" onclick="prevCard()">â†</button>
          <button class="btn btn-ghost" onclick="nextCard()">â†’</button>
        </div>
      </div>
      <div class="hint"><kbd>Ctrl+Enter</kbd> ì •ë‹µí™•ì¸ Â· <kbd>1</kbd> ì™¸ì› ë‹¤ Â· <kbd>2</kbd> ì¢€ ë” Â· <kbd>3</kbd> ëª¨ë¥´ê² ë‹¤</div>
    </div>

    <!-- ========== TAB 3: ì•”ê¸°í˜„í™© ========== -->
    <div id="tab-status" style="display:none">
      <div class="status-header">
        <div class="scard"><h4>ì „ì²´ ì§„ë„</h4><div class="num" id="s-pct">0%</div></div>
        <div class="scard"><h4>ì™„ë£Œ</h4><div class="num" id="s-done">0</div></div>
        <div class="scard"><h4>í•™ìŠµì¤‘</h4><div class="num" id="s-learn">0</div></div>
        <div class="scard"><h4>ë¯¸í•™ìŠµ</h4><div class="num" id="s-new">0</div></div>
      </div>
      <div class="filters" id="status-filters">
        <button class="fbtn on" onclick="setSF('all',this)">ì „ì²´</button>
        <button class="fbtn" onclick="setSF('mastered',this)">ì™„ë£Œ</button>
        <button class="fbtn" onclick="setSF('learning',this)">í•™ìŠµì¤‘</button>
        <button class="fbtn" onclick="setSF('new',this)">ë¯¸í•™ìŠµ</button>
      </div>
      <input class="search-box" id="s-search" placeholder="ê²€ìƒ‰ (ì œëª©, ë‚´ìš©)..." oninput="renderStatus()">
      <div class="status-list" id="s-list"></div>
      <div class="load-more" id="s-more"></div>
    </div>
  </div>
</main>

<footer>
  <div class="container">
    <p>&copy; 2026 Bobo's Home</p>
  </div>
</footer>

<!-- Modal -->
<div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="part" id="m-part"></div>
    <h2 id="m-title"></h2>
    <pre id="m-answer"></pre>
    <label>ì•”ê¸° ìƒíƒœ</label>
    <select id="m-status" onchange="modalStatusChange()">
      <option value="new">ë¯¸í•™ìŠµ</option>
      <option value="learning">í•™ìŠµì¤‘</option>
      <option value="mastered">ì™„ë£Œ</option>
    </select>
    <label>ì ìˆ˜ (ì§ì ‘ ì¡°ì •)</label>
    <div class="score-edit">
      <input type="range" id="m-score" min="0" max="100" value="0" oninput="document.getElementById('m-score-val').textContent=this.value+'%'">
      <div class="score-val" id="m-score-val">0%</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn" style="flex:1" onclick="saveModal()">ì €ì¥</button>
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal-bg" id="login-modal" onclick="if(event.target===this)closeLoginModal()">
  <div class="modal" style="max-width:400px">
    <h2>â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™”</h2>
    <p style="font-size:13px;color:#616161;margin-bottom:20px">ì•”í˜¸ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ì§„ë„ë¥¼ ì´ì–´ì„œ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
    <label>ì•”í˜¸ (4ì ì´ìƒ)</label>
    <input type="password" id="login-password" placeholder="ì•”í˜¸ ì…ë ¥" style="width:100%;padding:10px;background:#fff;border:1px solid #e0e0e0;color:#000;font-size:14px;margin-bottom:16px;outline:none">
    <div id="login-error" style="display:none;color:#000;background:#f5f5f5;padding:8px;font-size:12px;margin-bottom:12px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn" style="flex:1" onclick="handleLogin()">ë¡œê·¸ì¸</button>
      <button class="btn btn-ghost" style="flex:1" onclick="closeLoginModal()">ì·¨ì†Œ</button>
    </div>
    <p style="font-size:11px;color:#999;margin-top:16px;text-align:center">ğŸ’¡ ê°™ì€ ì•”í˜¸ë¡œ ëª¨ë“  ê¸°ê¸°ì—ì„œ ì ‘ì†í•˜ì„¸ìš”</p>
  </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAaMrOed3Zhj4ceappFkMozjYBF-CYx4g8",
  authDomain: "urani-study.firebaseapp.com",
  projectId: "urani-study",
  storageBucket: "urani-study.firebasestorage.app",
  messagingSenderId: "595550201149",
  appId: "1:595550201149:web:328525a314582c70ac5154"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let currentUserId = null;

// Hash password to create user ID
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

let CARDS=[], state={}, curTab='trace', curF='all', curP='all', curSF='all';
let filtered=[], idx=0;
let statusPage=0;
const PAGE_SIZE=50;

function load(){try{const s=localStorage.getItem('mb2');if(s)state=JSON.parse(s)}catch(e){}}
async function save(){
  localStorage.setItem('mb2',JSON.stringify(state));
  if(currentUserId){
    try{
      await setDoc(doc(db,'users',currentUserId),{progress:state,lastUpdated:Date.now()},{merge:true});
      document.getElementById('sync-status').style.display='inline';
      setTimeout(()=>document.getElementById('sync-status').style.display='none',2000);
    }catch(e){console.error('Sync error:',e)}
  }
}
function gs(id){return state[id]||{s:'new',sc:0,n:0}}
function ss(id,u){if(!state[id])state[id]={s:'new',sc:0,n:0};Object.assign(state[id],u);save()}

function applyFilter(){
  filtered=CARDS.filter(c=>{
    if(curF!=='all'&&c.category!==curF)return false;
    if(curP!=='all'&&c.part!==curP)return false;
    return true;
  });
  filtered.sort((a,b)=>{
    if(a.priority!==b.priority)return a.priority-b.priority;
    const o={new:0,learning:1,mastered:2};
    return(o[gs(a.id).s]||0)-(o[gs(b.id).s]||0);
  });
  idx=0;
  render();
}

window.setF=function(f,el){curF=f;document.querySelectorAll('[data-f]').forEach(b=>b.classList.toggle('on',b.dataset.f===f));applyFilter()}
window.setP=function(p,el){curP=p;document.querySelectorAll('[data-p]').forEach(b=>b.classList.toggle('on',b.dataset.p===p));applyFilter()}
window.setSF=function(f,el){curSF=f;el.parentElement.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));el.classList.add('on');renderStatus()}

window.switchTab=function(t){
  curTab=t;
  document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x.dataset.tab===t));
  document.getElementById('tab-trace').style.display=t==='trace'?'':'none';
  document.getElementById('tab-test').style.display=t==='test'?'':'none';
  document.getElementById('tab-status').style.display=t==='status'?'':'none';
  document.getElementById('shared-filters').style.display=t==='status'?'none':'';
  render();
}

window.render=function(){
  updateNav();
  if(curTab==='trace')renderTrace();
  else if(curTab==='test')renderTest();
  else renderStatus();
}

function updateNav(){
  let done=0,learn=0;
  CARDS.forEach(c=>{const s=gs(c.id).s;if(s==='mastered')done++;else if(s==='learning')learn++});
  document.getElementById('n-done').textContent=done;
  document.getElementById('n-learn').textContent=learn;
  document.getElementById('n-total').textContent=CARDS.length;
}

// ===== TAB 1: TRACE =====
window.renderTrace=function(){
  if(!filtered.length)return;
  const c=filtered[idx];
  document.getElementById('t1-badge').textContent=c.category;
  document.getElementById('t1-num').textContent=`${idx+1}/${filtered.length}`;
  const partText = c.page ? `${c.part} (p.${c.page})` : c.part;
  document.getElementById('t1-part').textContent=partText;
  document.getElementById('t1-title').textContent=c.prompt;
  document.getElementById('t1-answer').textContent=c.answer;
  document.getElementById('t1-input').value='';
  document.getElementById('t1-match').classList.remove('show');
  if(c.exam){document.getElementById('t1-exam').style.display='inline';document.getElementById('t1-exam').textContent='ê¸°ì¶œ: '+c.exam}
  else document.getElementById('t1-exam').style.display='none';
}

window.traceCheck=function(){
  const c=filtered[idx];
  const sc=score(document.getElementById('t1-input').value, c.answer);
  showMatch('t1',sc);
}

window.traceDone=function(){
  const c=filtered[idx];
  const sc=score(document.getElementById('t1-input').value, c.answer);
  const prev=gs(c.id);
  ss(c.id,{s:prev.s==='new'?'learning':prev.s, sc:Math.max(prev.sc,sc), n:prev.n+1});
  nextCard();
}

// ===== TAB 2: TEST =====
window.renderTest=function(){
  if(!filtered.length)return;
  const c=filtered[idx];
  document.getElementById('t2-badge').textContent=c.category;
  document.getElementById('t2-num').textContent=`${idx+1}/${filtered.length}`;
  const partText2 = c.page ? `${c.part} (p.${c.page})` : c.part;
  document.getElementById('t2-part').textContent=partText2;
  document.getElementById('t2-title').textContent=c.prompt;
  document.getElementById('t2-input').value='';
  document.getElementById('t2-match').classList.remove('show');
  document.getElementById('t2-reveal').classList.remove('show');
  document.getElementById('t2-btn-check').style.display='';
  document.getElementById('t2-btn-ok').style.display='none';
  document.getElementById('t2-btn-half').style.display='none';
  document.getElementById('t2-btn-fail').style.display='none';
  if(c.exam){document.getElementById('t2-exam').style.display='inline';document.getElementById('t2-exam').textContent='ê¸°ì¶œ: '+c.exam}
  else document.getElementById('t2-exam').style.display='none';
}

window.testCheck=function(){
  const c=filtered[idx];
  const sc=score(document.getElementById('t2-input').value, c.answer);
  showMatch('t2',sc);
  document.getElementById('t2-answer').textContent=c.answer;
  document.getElementById('t2-reveal').classList.add('show');
  document.getElementById('t2-btn-check').style.display='none';
  document.getElementById('t2-btn-ok').style.display='';
  document.getElementById('t2-btn-half').style.display='';
  document.getElementById('t2-btn-fail').style.display='';
  ss(c.id,{sc, n:(gs(c.id).n||0)+1});
}

window.testMark=function(status){
  const c=filtered[idx];
  ss(c.id,{s:status});
  updateNav();
  nextCard();
}

// ===== TAB 3: STATUS =====
window.renderStatus=function(){
  let done=0,learn=0,nw=0;
  CARDS.forEach(c=>{const s=gs(c.id).s;if(s==='mastered')done++;else if(s==='learning')learn++;else nw++});
  const pct=CARDS.length?Math.round(done/CARDS.length*100):0;
  document.getElementById('s-pct').textContent=pct+'%';
  document.getElementById('s-done').textContent=done;
  document.getElementById('s-learn').textContent=learn;
  document.getElementById('s-new').textContent=nw;

  const q=(document.getElementById('s-search').value||'').toLowerCase();
  let items=CARDS.filter(c=>{
    const st=gs(c.id).s;
    if(curSF!=='all'&&st!==curSF)return false;
    if(q&&!c.prompt.toLowerCase().includes(q)&&!c.answer.toLowerCase().includes(q))return false;
    return true;
  });

  // Sort: mastered last
  items.sort((a,b)=>{
    const o={new:0,learning:1,mastered:2};
    return(o[gs(a.id).s]||0)-(o[gs(b.id).s]||0);
  });

  const list=document.getElementById('s-list');
  const show=items.slice(0, PAGE_SIZE);
  list.innerHTML=show.map(c=>{
    const st=gs(c.id);
    const dotCls=st.s==='mastered'?'dot-mastered':st.s==='learning'?'dot-learning':'';
    const sbCls=st.sc>=80?'sb-high':st.sc>=50?'sb-mid':st.sc>0?'sb-low':'';
    const scText=st.sc+'%';
    return`<div class="srow" onclick="openModal('${c.id}')">
      <div class="dot ${dotCls}"></div>
      <div class="info">
        <div class="title">${esc(c.prompt)}</div>
        <div class="meta">${c.part}${c.page?' (p.'+c.page+')':''} Â· ${c.category}${c.exam?' Â· ê¸°ì¶œ':''}${st.n>0?' Â· '+st.n+'íšŒ':''}</div>
      </div>
      <div class="score-badge ${sbCls}">${scText}</div>
    </div>`;
  }).join('');

  const moreEl=document.getElementById('s-more');
  if(items.length>PAGE_SIZE){
    moreEl.innerHTML=`<button class="btn btn-ghost" onclick="loadMore()">ë” ë³´ê¸° (${items.length-PAGE_SIZE}ê°œ ë‚¨ìŒ)</button>`;
  } else moreEl.innerHTML='';
}

let statusShowCount=PAGE_SIZE;
window.loadMore=function(){statusShowCount+=PAGE_SIZE;renderStatus()}

// ===== MODAL =====
let modalCardId=null;
window.openModal=function(id){
  modalCardId=id;
  const c=CARDS.find(x=>x.id===id);
  const st=gs(id);
  const modalPart = c.page ? `${c.part} (p.${c.page}) Â· ${c.category}` : `${c.part} Â· ${c.category}`;
  document.getElementById('m-part').textContent=modalPart;
  document.getElementById('m-title').textContent=c.prompt;
  document.getElementById('m-answer').textContent=c.answer;
  document.getElementById('m-status').value=st.s;
  document.getElementById('m-score').value=st.sc;
  document.getElementById('m-score-val').textContent=st.sc+'%';
  document.getElementById('modal').classList.add('show');
}
window.closeModal=function(){document.getElementById('modal').classList.remove('show');modalCardId=null}
window.modalStatusChange=function(){}
window.saveModal=function(){
  if(!modalCardId)return;
  const newStatus=document.getElementById('m-status').value;
  const newScore=parseInt(document.getElementById('m-score').value);
  ss(modalCardId,{s:newStatus, sc:newScore});
  closeModal();
  render();
}

// ===== SCORING =====
function score(user,answer){
  const kw=t=>(t.match(/[ê°€-í£]{2,}/g)||[]);
  const ak=[...new Set(kw(answer))];
  if(!ak.length)return 100;
  const un=user.replace(/[\s.,;:!?()\[\]{}Â·â€¢â†’â†â‘ -â‘©/\\'"~`]/g,'').toLowerCase();
  let hit=0;
  ak.forEach(w=>{if(un.includes(w.toLowerCase()))hit++});
  return Math.round(hit/ak.length*100);
}

function showMatch(prefix,sc){
  const el=document.getElementById(prefix+'-match');
  el.classList.add('show');
  const fill=document.getElementById(prefix+'-fill');
  fill.style.width=sc+'%';
  document.getElementById(prefix+'-pct').textContent=sc+'%';
  const msg=sc>=80?'ê±°ì˜ ì™„ë²½!':sc>=50?'ì ˆë°˜ ì´ìƒ ë§ì•˜ì–´ìš”':sc>0?'ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ë³´ì„¸ìš”':'ì •ë‹µì„ í™•ì¸í•˜ì„¸ìš”';
  document.getElementById(prefix+'-match-msg').textContent=msg;
}

function esc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ===== NAV =====
window.nextCard=function(){idx=(idx+1)%filtered.length;render()}
window.prevCard=function(){idx=(idx-1+filtered.length)%filtered.length;render()}

// ===== KEYBOARD =====
document.addEventListener('keydown',e=>{
  if(curTab==='status')return;
  if(e.target.tagName==='TEXTAREA'){
    if(e.key==='Enter'&&e.ctrlKey){e.preventDefault();curTab==='trace'?traceCheck():testCheck()}
    return;
  }
  if(e.key==='ArrowRight')nextCard();
  if(e.key==='ArrowLeft')prevCard();
  if(curTab==='test'){
    if(e.key==='1')testMark('mastered');
    if(e.key==='2')testMark('learning');
    if(e.key==='3')testMark('new');
  }
});

// ===== LOGIN/LOGOUT =====
window.showLoginModal=function(){
  document.getElementById('login-modal').classList.add('show');
  document.getElementById('login-password').value='';
  document.getElementById('login-error').style.display='none';
  setTimeout(()=>document.getElementById('login-password').focus(),100);
}

window.closeLoginModal=function(){
  document.getElementById('login-modal').classList.remove('show');
}

window.handleLogin=async function(){
  const password=document.getElementById('login-password').value;
  const errorEl=document.getElementById('login-error');

  if(!password||password.length<4){
    errorEl.textContent='ì•”í˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•´ìš”';
    errorEl.style.display='block';
    return;
  }

  try{
    currentUserId=await hashPassword(password);
    const docRef=doc(db,'users',currentUserId);
    const docSnap=await getDoc(docRef);

    if(docSnap.exists()){
      const cloudData=docSnap.data();
      state=cloudData.progress||{};
      localStorage.setItem('mb2',JSON.stringify(state));
      alert('â˜ï¸ í´ë¼ìš°ë“œì—ì„œ ì§„ë„ë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”!');
    }else{
      await setDoc(docRef,{progress:state,createdAt:Date.now(),lastUpdated:Date.now()});
      alert('âœ¨ ìƒˆë¡œìš´ ê³„ì •ì´ ë§Œë“¤ì–´ì¡Œì–´ìš”!\nì´ì œ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ê°™ì€ ì•”í˜¸ë¡œ ë¡œê·¸ì¸í•˜ë©´ ì§„ë„ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤.');
    }

    document.getElementById('login-btn').style.display='none';
    document.getElementById('user-info').style.display='inline';
    document.getElementById('logout-btn').style.display='inline';
    closeLoginModal();
    render();
  }catch(e){
    console.error('Login error:',e);
    errorEl.textContent='ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message;
    errorEl.style.display='block';
  }
}

window.handleLogout=function(){
  if(confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ì–´ìš”?\në¡œì»¬ ì§„ë„ëŠ” ìœ ì§€ë˜ì§€ë§Œ í´ë¼ìš°ë“œ ë™ê¸°í™”ëŠ” ì¤‘ì§€ë©ë‹ˆë‹¤.')){
    currentUserId=null;
    document.getElementById('login-btn').style.display='inline';
    document.getElementById('user-info').style.display='none';
    document.getElementById('logout-btn').style.display='none';
    document.getElementById('sync-status').style.display='none';
  }
}

// ===== INIT =====
async function init(){
  load();
  try{
    const r=await fetch('cards_data.json');
    const d=await r.json();
    CARDS=d.cards;
  }catch(e){
    document.getElementById('t1-title').textContent='cards_data.json ë¡œë“œ ì‹¤íŒ¨';
    return;
  }
  applyFilter();
}
init();
</script>
</body>
</html>
